<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OCR Volantino</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            color: white;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255,255,255,0.8);
            text-align: center;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .products-section {
            grid-column: 1 / -1;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .products-table th, .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .products-table tr:hover {
            background: #f8f9fa;
        }

        .product-actions {
            display: flex;
            gap: 5px;
        }

        .product-actions button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .hidden-product {
            opacity: 0.5;
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .api-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-info h3 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .api-info code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Admin Dashboard</h1>
        <p>Gestione Backend OCR Volantino</p>
    </div>

    <div class="container">
        <div class="api-info">
            <h3>üì° Informazioni Backend</h3>
            <p><strong>API Backend:</strong> <code>http://localhost:8000</code></p>
            <p><strong>Admin Dashboard:</strong> <code>http://localhost:3000/admin.html</code></p>
            <p><strong>Interfaccia Pubblica:</strong> <code>http://localhost:3000</code></p>
        </div>

        <div class="dashboard-grid">
            <!-- Sezione Elaborazione PDF -->
            <div class="card">
                <h2>üìÑ Elabora PDF da URL</h2>
                <div class="form-group">
                    <label for="supermercatoNomePdf">Nome Supermercato: *</label>
                    <input type="text" id="supermercatoNomePdf" placeholder="Es: Conad, Coop, Esselunga..." required>
                </div>
                <div class="form-group">
                    <label for="pdfUrl">URL del PDF:</label>
                    <input type="url" id="pdfUrl" placeholder="https://esempio.com/volantino.pdf">
                </div>
                <div class="form-group">
                    <label for="jobName">Nome Job (opzionale):</label>
                    <input type="text" id="jobName" placeholder="Volantino Supermercato XYZ">
                </div>
                <button class="btn" onclick="startPdfProcessing()">üöÄ Avvia Elaborazione</button>
                <div id="pdfStatus"></div>
            </div>

            <!-- Sezione Upload File -->
            <div class="card">
                <h2>üìÅ Upload File Locale</h2>
                <div class="form-group">
                    <label for="supermercatoNomeUpload">Nome Supermercato: *</label>
                    <input type="text" id="supermercatoNomeUpload" placeholder="Es: Conad, Coop, Esselunga..." required>
                </div>
                <div class="form-group">
                    <label for="fileUpload">Seleziona File:</label>
                    <input type="file" id="fileUpload" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                <button class="btn" onclick="uploadFile()">üì§ Upload ed Elabora</button>
                <div id="uploadStatus"></div>
            </div>

            <!-- Sezione Jobs Attivi -->
            <div class="card">
                <h2>‚öôÔ∏è Jobs Attivi</h2>
                <button class="btn" onclick="loadActiveJobs()">üîÑ Aggiorna Lista</button>
                <div id="activeJobs"></div>
            </div>

            <!-- Sezione Statistiche -->
            <div class="card">
                <h2>üìä Statistiche Sistema</h2>
                <button class="btn" onclick="loadStats()">üìà Carica Statistiche</button>
                <div id="systemStats"></div>
            </div>
        </div>

        <!-- Sezione Gestione Prodotti -->
        <div class="card products-section">
            <h2>üõí Gestione Prodotti</h2>
            <div class="form-group">
                <label for="jobIdProducts">Job ID per caricare prodotti:</label>
                <input type="text" id="jobIdProducts" placeholder="Inserisci Job ID">
                <button class="btn" onclick="loadProducts()">üì¶ Carica Prodotti</button>
            </div>
            <div id="productsContainer"></div>
        </div>

        <!-- Sezione Prodotti per Supermercato -->
        <div class="card supermarket-products-section">
            <h2>üè™ Prodotti per Supermercato</h2>
            <div class="form-group">
                <label for="supermarketSelect">Seleziona Supermercato:</label>
                <select id="supermarketSelect" onchange="loadProductsForSelectedSupermarket()">
                    <option value="">-- Seleziona un supermercato --</option>
                </select>
                <button class="btn" onclick="loadProductsBySupermarket()">üîÑ Carica Tutti i Prodotti</button>
                <button class="btn btn-danger" onclick="deleteAllProducts()" style="margin-left: 10px;">üóëÔ∏è Elimina Tutti i Prodotti</button>
            </div>
            <div id="supermarketProductsContainer"></div>
        </div>

        <!-- Sezione Gestione Supermercati -->
        <div class="card supermarkets-section">
            <h2>üè¨ Gestione Supermercati</h2>
            
            <!-- Form per aggiungere nuovo supermercato -->
            <div class="form-group">
                <h3>‚ûï Aggiungi Nuovo Supermercato</h3>
                <div class="form-group">
                    <label for="newSupermercatoNome">Nome Supermercato: *</label>
                    <input type="text" id="newSupermercatoNome" placeholder="Es: Conad, Coop, Esselunga..." required>
                </div>
                <div class="form-group">
                    <label for="newSupermercatoDescrizione">Descrizione:</label>
                    <textarea id="newSupermercatoDescrizione" placeholder="Descrizione del supermercato..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="newSupermercatoLogoUrl">URL Logo:</label>
                    <input type="url" id="newSupermercatoLogoUrl" placeholder="https://esempio.com/logo.png">
                </div>
                <div class="form-group">
                    <label for="newSupermercatoSitoWeb">Sito Web:</label>
                    <input type="url" id="newSupermercatoSitoWeb" placeholder="https://www.supermercato.it">
                </div>
                <div class="form-group">
                    <label for="newSupermercatoColore">Colore Tema:</label>
                    <input type="color" id="newSupermercatoColore" value="#3498db">
                </div>
                <button class="btn btn-success" onclick="createSupermercato()">‚ûï Crea Supermercato</button>
            </div>
            
            <!-- Lista supermercati esistenti -->
            <div class="form-group">
                <h3>üìã Supermercati Esistenti</h3>
                <button class="btn" onclick="loadSupermercati()">üîÑ Aggiorna Lista</button>
                <div id="supermercatiContainer"></div>
            </div>
            
            <!-- Form per upload PDF per supermercato -->
            <div class="form-group">
                <h3>üìÑ Carica PDF per Supermercato</h3>
                <div class="form-group">
                    <label for="selectSupermercato">Seleziona Supermercato:</label>
                    <select id="selectSupermercato">
                        <option value="">-- Seleziona Supermercato --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pdfUrlSupermercato">URL PDF:</label>
                    <input type="url" id="pdfUrlSupermercato" placeholder="https://esempio.com/volantino.pdf">
                </div>
                <div class="form-group">
                    <label for="pdfFileSupermercato">Oppure carica file:</label>
                    <input type="file" id="pdfFileSupermercato" accept=".pdf">
                </div>
                <button class="btn" onclick="processPdfForSupermercato()">üöÄ Elabora PDF</button>
                <div id="pdfSupermercatoStatus"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Inizializzazione pagina
        window.addEventListener('DOMContentLoaded', function() {
            loadSupermarketSelect();
        });

        // Funzione per elaborare PDF da URL
        async function startPdfProcessing() {
            const url = document.getElementById('pdfUrl').value.trim();
            const supermercatoNome = document.getElementById('supermercatoNomePdf').value.trim();
            const jobName = document.getElementById('jobName').value.trim();
            
            if (!url) {
                showStatus('pdfStatus', 'Inserisci un URL valido', 'error');
                return;
            }
            
            if (!supermercatoNome) {
                showStatus('pdfStatus', 'Inserisci il nome del supermercato', 'error');
                return;
            }

            showStatus('pdfStatus', '‚è≥ Avvio elaborazione...', 'info');

            try {
                const response = await fetch(`${API_BASE}/process-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        supermercato_nome: supermercatoNome,
                        job_name: jobName || 'PDF Processing'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('pdfStatus', `‚úÖ Elaborazione avviata! Job ID: ${result.job_id}`, 'success');
                } else {
                    throw new Error(`Errore ${response.status}`);
                }
            } catch (error) {
                showStatus('pdfStatus', `‚ùå Errore: ${error.message}. Endpoint non ancora implementato.`, 'error');
            }
        }

        // Funzione per upload file
        async function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const supermercatoNome = document.getElementById('supermercatoNomeUpload').value.trim();
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('uploadStatus', 'Seleziona un file', 'error');
                return;
            }
            
            if (!supermercatoNome) {
                showStatus('uploadStatus', 'Inserisci il nome del supermercato', 'error');
                return;
            }

            showStatus('uploadStatus', '‚è≥ Upload in corso...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('supermercato_nome', supermercatoNome);

                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('uploadStatus', `‚úÖ Upload completato! Job ID: ${result.job_id}`, 'success');
                    document.getElementById('jobIdProducts').value = result.job_id;
                } else {
                    throw new Error(`Errore ${response.status}`);
                }
            } catch (error) {
                showStatus('uploadStatus', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Funzione per caricare jobs attivi
        async function loadActiveJobs() {
            const container = document.getElementById('activeJobs');
            container.innerHTML = '<div class="loading">‚è≥ Caricamento jobs...</div>';

            try {
                // Simula caricamento jobs - da implementare endpoint
                setTimeout(() => {
                    container.innerHTML = `
                        <div class="status info">
                            üìã Endpoint /jobs non ancora implementato.<br>
                            Usa il Job ID dai risultati di upload per gestire i prodotti.
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore: ${error.message}</div>`;
            }
        }

        // Funzione per caricare statistiche
        async function loadStats() {
            const container = document.getElementById('systemStats');
            container.innerHTML = '<div class="loading">‚è≥ Caricamento statistiche...</div>';

            try {
                const response = await fetch(`${API_BASE}/health`);
                const health = await response.json();
                
                container.innerHTML = `
                    <div class="status success">
                        <strong>üü¢ Sistema Operativo</strong><br>
                        Status: ${health.status}<br>
                        Database: ${health.database ? '‚úÖ Connesso' : '‚ùå Disconnesso'}<br>
                        Timestamp: ${new Date(health.timestamp).toLocaleString('it-IT')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore: ${error.message}</div>`;
            }
        }

        // Funzione per caricare prodotti
        async function loadProducts() {
            const jobId = document.getElementById('jobIdProducts').value.trim();
            const container = document.getElementById('productsContainer');
            
            if (!jobId) {
                showStatus('productsContainer', 'Inserisci un Job ID', 'error');
                return;
            }

            container.innerHTML = '<div class="loading">‚è≥ Caricamento prodotti...</div>';

            try {
                const response = await fetch(`${API_BASE}/products/${jobId}`);
                
                if (!response.ok) {
                    throw new Error(`Job non trovato: ${response.status}`);
                }

                const products = await response.json();
                displayProductsTable(products, container);
                
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore: ${error.message}</div>`;
            }
        }

        // Funzione per visualizzare tabella prodotti
        function displayProductsTable(products, container) {
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="status info">üì¶ Nessun prodotto trovato</div>';
                return;
            }

            const table = `
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Prezzo</th>
                            <th>Marca</th>
                            <th>Categoria</th>
                            <th>Quantit√†</th>
                            <th>Immagine</th>
                            <th>Confidence</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr id="product-${product.id}" class="${product.hidden ? 'hidden-product' : ''}">
                                <td>${product.id}</td>
                                <td>
                                    <input type="text" value="${product.nome || ''}" 
                                           onchange="updateProduct(${product.id}, 'nome', this.value)" 
                                           style="border:1px solid #ddd; padding:4px; width:100%; border-radius:3px;">
                                </td>
                                <td>
                                    <input type="number" value="${product.prezzo || 0}" step="0.01"
                                           onchange="updateProduct(${product.id}, 'prezzo', this.value)" 
                                           style="border:1px solid #ddd; padding:4px; width:80px; border-radius:3px;">
                                </td>
                                <td>
                                    <input type="text" value="${product.marca || ''}" 
                                           onchange="updateProduct(${product.id}, 'marca', this.value)" 
                                           style="border:1px solid #ddd; padding:4px; width:100%; border-radius:3px;">
                                </td>
                                <td>
                                    <input type="text" value="${product.categoria || ''}" 
                                           onchange="updateProduct(${product.id}, 'categoria', this.value)" 
                                           style="border:1px solid #ddd; padding:4px; width:100%; border-radius:3px;">
                                </td>
                                <td>
                                    <input type="text" value="${product.quantita || ''}" 
                                           onchange="updateProduct(${product.id}, 'quantita', this.value)" 
                                           style="border:1px solid #ddd; padding:4px; width:80px; border-radius:3px;">
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                        <input type="url" value="${product.image_url || ''}" 
                                               onchange="updateProduct(${product.id}, 'image_url', this.value)" 
                                               placeholder="URL immagine..."
                                               style="border:1px solid #ddd; padding:2px; width:120px; font-size:12px; border-radius:3px;">
                                        ${product.image_url ? `<img src="${product.image_url}" alt="${product.nome}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;" onerror="this.style.display='none'">` : '<span style="font-size:12px; color:#999;">Nessuna immagine</span>'}
                                    </div>
                                </td>
                                <td>${Math.round((product.confidence_score || 0) * 100)}%</td>
                                <td class="product-actions">
                                    <button class="btn" onclick="toggleProduct(${product.id})" title="Nascondi/Mostra">
                                        ${product.hidden ? 'üëÅÔ∏è' : 'üôà'}
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteProduct(${product.id})" title="Elimina">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Funzioni per gestione prodotti
        async function updateProduct(productId, field, value) {
            try {
                const updateData = {};
                updateData[field] = value;
                
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ Prodotto ${productId} aggiornato: ${field} = ${value}`);
                
                // Mostra feedback visivo
                const row = document.getElementById(`product-${productId}`);
                if (row) {
                    row.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 1000);
                }
                
            } catch (error) {
                console.error(`‚ùå Errore aggiornamento prodotto ${productId}:`, error);
                alert(`Errore durante l'aggiornamento: ${error.message}`);
            }
        }

        async function saveProduct(productId) {
            // Questa funzione non √® pi√π necessaria dato che updateProduct salva automaticamente
            console.log(`Prodotto ${productId} gi√† salvato automaticamente`);
        }

        async function toggleProduct(productId) {
            try {
                const row = document.getElementById(`product-${productId}`);
                const isHidden = row.classList.contains('hidden-product');
                
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hidden: !isHidden })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }
                
                row.classList.toggle('hidden-product');
                console.log(`‚úÖ Visibilit√† prodotto ${productId} cambiata`);
                
            } catch (error) {
                console.error(`‚ùå Errore toggle prodotto ${productId}:`, error);
                alert(`Errore durante il cambio visibilit√†: ${error.message}`);
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                try {
                    const response = await fetch(`${API_BASE}/products/${productId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Errore ${response.status}`);
                    }
                    
                    // Rimuovi la riga dalla tabella
                    const row = document.getElementById(`product-${productId}`);
                    if (row) {
                        row.remove();
                    }
                    
                    console.log(`‚úÖ Prodotto ${productId} eliminato`);
                    
                } catch (error) {
                    console.error(`‚ùå Errore eliminazione prodotto ${productId}:`, error);
                    alert(`Errore durante l'eliminazione: ${error.message}`);
                }
            }
        }

        async function deleteAllProducts() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questa operazione eliminer√† TUTTI i prodotti dal database.\n\nSei sicuro di voler continuare? Questa azione NON pu√≤ essere annullata.')) {
                try {
                    const response = await fetch(`${API_BASE}/products/all`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Errore ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    // Mostra messaggio di successo
                    alert(`‚úÖ ${result.message}\nProdotti eliminati: ${result.deleted_count}`);
                    
                    // Ricarica la pagina per aggiornare tutte le tabelle
                    location.reload();
                    
                    console.log(`‚úÖ Eliminati tutti i prodotti: ${result.deleted_count}`);
                    
                } catch (error) {
                    console.error(`‚ùå Errore eliminazione tutti i prodotti:`, error);
                    alert(`Errore durante l'eliminazione di tutti i prodotti: ${error.message}`);
                }
            }
        }

        // Funzione per popolare il menu a tendina dei supermercati
        async function loadSupermarketSelect() {
            try {
                const response = await fetch(`${API_BASE}/supermercati`);
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }
                
                const supermercati = await response.json();
                const select = document.getElementById('supermarketSelect');
                
                // Pulisci le opzioni esistenti (tranne la prima)
                select.innerHTML = '<option value="">-- Seleziona un supermercato --</option>';
                
                // Aggiungi i supermercati
                supermercati.forEach(supermercato => {
                    const option = document.createElement('option');
                    option.value = supermercato.nome;
                    option.textContent = supermercato.nome;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Errore nel caricamento supermercati:', error);
            }
        }
        
        // Funzione per caricare prodotti del supermercato selezionato
        async function loadProductsForSelectedSupermarket() {
            const selectedSupermarket = document.getElementById('supermarketSelect').value;
            const container = document.getElementById('supermarketProductsContainer');
            
            if (!selectedSupermarket) {
                container.innerHTML = '<div class="status info">üìã Seleziona un supermercato per visualizzare i prodotti</div>';
                return;
            }
            
            container.innerHTML = '<div class="loading">‚è≥ Caricamento prodotti...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/products-by-supermarket`);
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }
                
                const data = await response.json();
                
                // Trova il supermercato selezionato
                const supermarketInfo = data.supermarkets.find(s => s.nome === selectedSupermarket);
                
                if (!supermarketInfo || !supermarketInfo.products || supermarketInfo.products.length === 0) {
                    container.innerHTML = '<div class="status info">üì≠ Nessun prodotto trovato per questo supermercato</div>';
                    return;
                }
                
                // Crea la tabella editabile per i prodotti
                displayEditableProductsTable(supermarketInfo.products, container, selectedSupermarket);
                
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore nel caricamento: ${error.message}</div>`;
            }
        }
        
        // Funzione per visualizzare tabella prodotti editabile
        function displayEditableProductsTable(products, container, supermarketName) {
            const table = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2c3e50;">üè™ ${supermarketName} - ${products.length} prodotti</h3>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Prezzo</th>
                            <th>Marca</th>
                            <th>Categoria</th>
                            <th>Quantit√†</th>
                            <th>Immagine</th>
                            <th>Confidence</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr id="product-${product.id}" class="${product.hidden ? 'hidden-product' : ''}">
                                <td>${product.id}</td>
                                <td>
                                    <input type="text" value="${product.nome || ''}" 
                                           onchange="updateProduct(${product.id}, 'nome', this.value)" 
                                           style="border:none; background:transparent; width:100%;">
                                </td>
                                <td>
                                    <input type="number" value="${product.prezzo || 0}" step="0.01"
                                           onchange="updateProduct(${product.id}, 'prezzo', this.value)" 
                                           style="border:none; background:transparent; width:80px;">
                                </td>
                                <td>
                                    <input type="text" value="${product.marca || ''}" 
                                           onchange="updateProduct(${product.id}, 'marca', this.value)" 
                                           style="border:none; background:transparent; width:100%;">
                                </td>
                                <td>
                                    <input type="text" value="${product.categoria || ''}" 
                                           onchange="updateProduct(${product.id}, 'categoria', this.value)" 
                                           style="border:none; background:transparent; width:100%;">
                                </td>
                                <td>
                                    <input type="text" value="${product.quantita || ''}" 
                                           onchange="updateProduct(${product.id}, 'quantita', this.value)" 
                                           style="border:none; background:transparent; width:80px;">
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                        <input type="url" value="${product.image_url || ''}" 
                                               onchange="updateProduct(${product.id}, 'image_url', this.value)" 
                                               placeholder="URL immagine..."
                                               style="border:none; background:transparent; width:120px; font-size:12px;">
                                        ${product.image_url ? `<img src="${product.image_url}" alt="${product.nome}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;" onerror="this.style.display='none'">` : '<span style="font-size:12px; color:#999;">Nessuna immagine</span>'}
                                    </div>
                                </td>
                                <td>${Math.round((product.confidence_score || 0) * 100)}%</td>
                                <td class="product-actions">
                                    <button class="btn" onclick="toggleProduct(${product.id})" title="Nascondi/Mostra">
                                        ${product.hidden ? 'üëÅÔ∏è' : 'üôà'}
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteProduct(${product.id})" title="Elimina">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Funzione per caricare prodotti per supermercato
        async function loadProductsBySupermarket() {
            const container = document.getElementById('supermarketProductsContainer');
            container.innerHTML = '<div class="loading">‚è≥ Caricamento prodotti...</div>';

            try {
                const response = await fetch(`${API_BASE}/products-by-supermarket`);
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.supermarkets || data.supermarkets.length === 0) {
                    container.innerHTML = '<div class="status info">üì≠ Nessun prodotto trovato nel database</div>';
                    return;
                }

                let html = '';
                for (const info of data.supermarkets) {
                    html += `
                         <div class="supermarket-section" style="margin-bottom: 30px; border: 2px solid #3498db; border-radius: 10px; padding: 20px;">
                             <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem;">üè™ ${info.nome}</h3>
                            <p style="color: #666; margin-bottom: 15px;">üìä Totale prodotti: <strong>${info.total_products}</strong> | üìã Job: <strong>${info.jobs.length}</strong></p>
                            <div class="products-grid" style="display: grid; gap: 15px;">
                    `;
                    
                    info.products.forEach(product => {
                        const prezzo = product.prezzo ? `‚Ç¨${product.prezzo.toFixed(2)}` : 'N/A';
                        const prezzoOriginale = product.prezzo_originale ? `‚Ç¨${product.prezzo_originale.toFixed(2)}` : '';
                        const sconto = product.sconto_percentuale ? `${product.sconto_percentuale}%` : '';
                        
                        html += `
                            <div class="product-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h4 style="color: #2c3e50; margin-bottom: 8px;">${product.nome}</h4>
                                        <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9rem; color: #666;">
                                            <span><strong>üí∞ Prezzo:</strong> ${prezzo}</span>
                                            ${prezzoOriginale ? `<span><strong>üè∑Ô∏è Originale:</strong> ${prezzoOriginale}</span>` : ''}
                                            ${sconto ? `<span style="color: #e74c3c;"><strong>üî• Sconto:</strong> ${sconto}</span>` : ''}
                                            ${product.quantita ? `<span><strong>üì¶ Quantit√†:</strong> ${product.quantita}</span>` : ''}
                                            ${product.marca ? `<span><strong>üè∑Ô∏è Marca:</strong> ${product.marca}</span>` : ''}
                                            ${product.categoria ? `<span><strong>üìÇ Categoria:</strong> ${product.categoria}</span>` : ''}
                                        </div>
                                        <div style="margin-top: 8px; font-size: 0.8rem; color: #999;">
                                            <span><strong>üÜî Job ID:</strong> ${product.job_id}</span>
                                            ${product.confidence_score ? ` | <strong>üéØ Confidenza:</strong> ${(product.confidence_score * 100).toFixed(1)}%` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore nel caricamento: ${error.message}</div>`;
            }
        }

        // Funzione helper per mostrare status
        function showStatus(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // === FUNZIONI PER GESTIONE SUPERMERCATI ===
        
        // Crea nuovo supermercato
        async function createSupermercato() {
            const nome = document.getElementById('newSupermercatoNome').value.trim();
            const descrizione = document.getElementById('newSupermercatoDescrizione').value.trim();
            const logoUrl = document.getElementById('newSupermercatoLogoUrl').value.trim();
            const sitoWeb = document.getElementById('newSupermercatoSitoWeb').value.trim();
            const coloreTema = document.getElementById('newSupermercatoColore').value;
            
            if (!nome) {
                alert('Il nome del supermercato √® obbligatorio!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/supermercati`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        descrizione: descrizione || null,
                        logo_url: logoUrl || null,
                        sito_web: sitoWeb || null,
                        colore_tema: coloreTema
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante la creazione');
                }
                
                const supermercato = await response.json();
                
                // Reset form
                document.getElementById('newSupermercatoNome').value = '';
                document.getElementById('newSupermercatoDescrizione').value = '';
                document.getElementById('newSupermercatoLogoUrl').value = '';
                document.getElementById('newSupermercatoSitoWeb').value = '';
                document.getElementById('newSupermercatoColore').value = '#3498db';
                
                // Ricarica lista
                loadSupermercati();
                
                // Chiedi se vuole elaborare un PDF per questo supermercato
                const elaboraPdf = confirm(`‚úÖ Supermercato "${supermercato.nome}" creato con successo!\n\nVuoi elaborare un volantino PDF per questo supermercato?`);
                
                if (elaboraPdf) {
                    // Seleziona automaticamente il supermercato appena creato
                    setTimeout(() => {
                        const selectSupermercato = document.getElementById('selectSupermercato');
                        selectSupermercato.value = supermercato.id;
                        
                        // Scorri alla sezione upload PDF
                        const pdfSection = document.querySelector('.card:has(#selectSupermercato)');
                        if (pdfSection) {
                            pdfSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        // Evidenzia il campo URL PDF
                        document.getElementById('pdfUrlSupermercato').focus();
                    }, 500);
                } else {
                    alert(`‚úÖ Supermercato "${supermercato.nome}" creato con successo!`);
                }
                
            } catch (error) {
                alert(`‚ùå Errore: ${error.message}`);
            }
        }
        
        // Carica lista supermercati
        async function loadSupermercati() {
            const container = document.getElementById('supermercatiContainer');
            const select = document.getElementById('selectSupermercato');
            
            container.innerHTML = '<div class="loading">‚è≥ Caricamento supermercati...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/supermercati`);
                if (!response.ok) {
                    throw new Error(`Errore ${response.status}`);
                }
                
                const supermercati = await response.json();
                
                if (supermercati.length === 0) {
                    container.innerHTML = '<div class="status info">üì≠ Nessun supermercato trovato</div>';
                    return;
                }
                
                // Aggiorna select
                select.innerHTML = '<option value="">-- Seleziona Supermercato --</option>';
                supermercati.forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${s.nome}</option>`;
                });
                
                // Mostra lista
                let html = '<div style="margin-top: 15px;">';
                supermercati.forEach(s => {
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: ${s.colore_tema};">${s.nome}</h4>
                                    ${s.descrizione ? `<p style="margin: 5px 0; color: #666;">${s.descrizione}</p>` : ''}
                                    <small style="color: #999;">Jobs: ${s.total_jobs} | Creato: ${new Date(s.created_at).toLocaleDateString()}</small>
                                </div>
                                <div>
                                    <button class="btn" onclick="editSupermercato(${s.id})">‚úèÔ∏è Modifica</button>
                                    <button class="btn btn-danger" onclick="deleteSupermercato(${s.id}, '${s.nome}')">üóëÔ∏è Elimina</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Errore nel caricamento: ${error.message}</div>`;
            }
        }
        
        // Elimina supermercato
        async function deleteSupermercato(id, nome) {
            if (!confirm(`Sei sicuro di voler eliminare il supermercato "${nome}"?\nQuesta azione disattiver√† il supermercato ma manterr√† i dati esistenti.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/supermercati/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante l\'eliminazione');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                loadSupermercati();
                
            } catch (error) {
                alert(`‚ùå Errore: ${error.message}`);
            }
        }
        
        // Modifica supermercato
        async function editSupermercato(id) {
            try {
                // Carica dati supermercato
                const response = await fetch(`${API_BASE}/supermercati`);
                if (!response.ok) throw new Error('Errore nel caricamento');
                
                const supermercati = await response.json();
                const supermercato = supermercati.find(s => s.id === id);
                
                if (!supermercato) {
                    alert('Supermercato non trovato!');
                    return;
                }
                
                // Crea form di modifica
                const editForm = `
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px;">
                        <h3 style="margin-top: 0; color: #2c3e50;">‚úèÔ∏è Modifica Supermercato</h3>
                        
                        <div class="form-group">
                            <label>Nome Supermercato: *</label>
                            <input type="text" id="editNome" value="${supermercato.nome}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Descrizione:</label>
                            <textarea id="editDescrizione" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${supermercato.descrizione || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>URL Logo:</label>
                            <input type="url" id="editLogoUrl" value="${supermercato.logo_url || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Sito Web:</label>
                            <input type="url" id="editSitoWeb" value="${supermercato.sito_web || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Colore Tema:</label>
                            <input type="color" id="editColore" value="${supermercato.colore_tema}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px;">
                            <button onclick="closeEditForm()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">‚ùå Annulla</button>
                            <button onclick="saveSupermercato(${id})" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üíæ Salva</button>
                        </div>
                    </div>
                    <div id="editOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" onclick="closeEditForm()"></div>
                `;
                
                // Aggiungi form al body
                const formContainer = document.createElement('div');
                formContainer.id = 'editFormContainer';
                formContainer.innerHTML = editForm;
                document.body.appendChild(formContainer);
                
            } catch (error) {
                alert(`‚ùå Errore: ${error.message}`);
            }
        }
        
        // Chiudi form di modifica
        function closeEditForm() {
            const container = document.getElementById('editFormContainer');
            if (container) {
                container.remove();
            }
        }
        
        // Salva modifiche supermercato
        async function saveSupermercato(id) {
            const nome = document.getElementById('editNome').value.trim();
            const descrizione = document.getElementById('editDescrizione').value.trim();
            const logoUrl = document.getElementById('editLogoUrl').value.trim();
            const sitoWeb = document.getElementById('editSitoWeb').value.trim();
            const coloreTema = document.getElementById('editColore').value;
            
            if (!nome) {
                alert('Il nome del supermercato √® obbligatorio!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/supermercati/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        descrizione: descrizione || null,
                        logo_url: logoUrl || null,
                        sito_web: sitoWeb || null,
                        colore_tema: coloreTema
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante il salvataggio');
                }
                
                const supermercato = await response.json();
                alert(`‚úÖ Supermercato "${supermercato.nome}" aggiornato con successo!`);
                
                closeEditForm();
                loadSupermercati();
                
            } catch (error) {
                alert(`‚ùå Errore: ${error.message}`);
            }
        }
        
        // Elabora PDF per supermercato
        async function processPdfForSupermercato() {
            const supermercatoId = document.getElementById('selectSupermercato').value;
            const pdfUrl = document.getElementById('pdfUrlSupermercato').value.trim();
            const pdfFile = document.getElementById('pdfFileSupermercato').files[0];
            
            if (!supermercatoId) {
                showStatus('pdfSupermercatoStatus', 'Seleziona un supermercato', 'error');
                return;
            }
            
            if (!pdfUrl && !pdfFile) {
                showStatus('pdfSupermercatoStatus', 'Inserisci un URL o seleziona un file', 'error');
                return;
            }
            
            // Ottieni nome supermercato
            const select = document.getElementById('selectSupermercato');
            const supermercatoNome = select.options[select.selectedIndex].text;
            
            showStatus('pdfSupermercatoStatus', '‚è≥ Avvio elaborazione...', 'info');
            
            try {
                let response;
                
                if (pdfUrl) {
                    // Elabora da URL
                    response = await fetch(`${API_BASE}/process-url`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: pdfUrl,
                            supermercato_nome: supermercatoNome,
                            job_name: `PDF ${supermercatoNome} - ${new Date().toLocaleDateString()}`
                        })
                    });
                } else {
                    // Upload file
                    const formData = new FormData();
                    formData.append('file', pdfFile);
                    formData.append('supermercato_nome', supermercatoNome);
                    
                    response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante l\'elaborazione');
                }
                
                const result = await response.json();
                showStatus('pdfSupermercatoStatus', `‚úÖ Elaborazione avviata! Job ID: ${result.job_id}`, 'success');
                
                // Avvia monitoraggio automatico del job
                monitorJobProgress(result.job_id, 'pdfSupermercatoStatus');
                
                // Reset form
                document.getElementById('pdfUrlSupermercato').value = '';
                document.getElementById('pdfFileSupermercato').value = '';
                
            } catch (error) {
                showStatus('pdfSupermercatoStatus', `‚ùå Errore: ${error.message}`, 'error');
            }
        }
        
        // Monitora il progresso di un job in tempo reale
        async function monitorJobProgress(jobId, statusElementId) {
            const maxAttempts = 60; // Massimo 5 minuti (60 * 5 secondi)
            let attempts = 0;
            
            const checkStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE}/jobs/${jobId}`);
                    
                    if (!response.ok) {
                        throw new Error('Errore nel recupero stato job');
                    }
                    
                    const jobStatus = await response.json();
                    
                    // Aggiorna l'interfaccia in base al progresso
                    if (jobStatus.status === 'processing') {
                        const progress = jobStatus.progress || 0;
                        showStatus(statusElementId, `‚öôÔ∏è Elaborazione in corso... ${progress}% - ${jobStatus.message || 'Processando...'}`, 'info');
                    } else if (jobStatus.status === 'completed') {
                        // Recupera il numero di prodotti dal database
                        const productsResponse = await fetch(`${API_BASE}/products/${jobId}`);
                        let totalProducts = 'N/A';
                        if (productsResponse.ok) {
                            const products = await productsResponse.json();
                            totalProducts = products.length;
                        }
                        
                        showStatus(statusElementId, `üéâ Elaborazione completata! Prodotti estratti: ${totalProducts}`, 'success');
                        
                        // Mostra link ai risultati
                        setTimeout(() => {
                            const statusEl = document.getElementById(statusElementId);
                            if (statusEl) {
                                statusEl.innerHTML += `<br><a href="${API_BASE}/results/${jobId}" target="_blank" style="color: #2980b9; text-decoration: underline;">üìã Visualizza risultati completi</a>`;
                            }
                        }, 1000);
                        
                        // Aggiorna lista supermercati
                        loadSupermercati();
                        return; // Stop monitoring
                    } else if (jobStatus.status === 'failed') {
                        showStatus(statusElementId, `‚ùå Elaborazione fallita: ${jobStatus.message || 'Errore sconosciuto'}`, 'error');
                        return; // Stop monitoring
                    } else if (jobStatus.status === 'queued') {
                        showStatus(statusElementId, '‚è≥ Job in coda, in attesa di elaborazione...', 'info');
                    }
                    
                    attempts++;
                    
                    // Continua il monitoraggio se non completato e non superato il limite
                    if (attempts < maxAttempts && (jobStatus.status === 'processing' || jobStatus.status === 'queued')) {
                        setTimeout(checkStatus, 5000); // Controlla ogni 5 secondi
                    } else if (attempts >= maxAttempts) {
                        showStatus(statusElementId, '‚ö†Ô∏è Timeout monitoraggio. Controlla manualmente lo stato del job.', 'error');
                    }
                    
                } catch (error) {
                    console.error('Errore monitoraggio job:', error);
                    attempts++;
                    
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 10000); // Riprova dopo 10 secondi in caso di errore
                    } else {
                        showStatus(statusElementId, '‚ùå Errore nel monitoraggio del job', 'error');
                    }
                }
            };
            
            // Avvia il monitoraggio dopo 2 secondi
            setTimeout(checkStatus, 2000);
        }

        // Carica statistiche all'avvio
        window.addEventListener('load', () => {
            loadStats();
            loadSupermercati(); // Carica anche i supermercati
        });
    </script>
</body>
</html>